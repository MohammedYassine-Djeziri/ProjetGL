<!-- Basic HTML structure with embedded CSS and Stripe payment integration -->
<!DOCTYPE html>
<html>
  <head>
    <!-- Page title and styling -->
    <title>Buy cool new course</title>
    
    <!-- Stripe and polyfill script imports for cross-browser compatibility -->
    <script src="https://polyfill.io/v3/polyfill.min.js?version=3.52.1&features=fetch"></script>
    <script src="https://js.stripe.com/v3/"></script>

    <!-- Embedded CSS for styling the payment form -->
    <style>
      /* Comprehensive styling for the payment form, buttons, and loading spinner */
      /* Includes responsive design, form layout, and visual effects */
    </style>
  </head>

  <body>
    <section>
      <!-- Product Display Area -->
      <div class="course">
        <!-- Django template tags to dynamically display product details -->
        <div class="description">
          <h3>{{ course.title }}</h3> <!-- Product name -->
          <h5>${{ course.price }}</h5> <!-- Product price -->
        </div>
      </div>

      <!-- Checkout Button -->
      <button type="button" id="checkout-button">Checkout</button>

      <!-- Django CSRF Token for security -->
      {% csrf_token %}
    </section>

    <!-- JavaScript for Stripe Payment Processing -->
    <script type="text/javascript">
      // Retrieve CSRF token for Django security
      const csrftoken = document.querySelector('[name=csrfmiddlewaretoken]').value;

      // Initialize Stripe with public key
      var stripe = Stripe("{{ STRIPE_PUBLIC_KEY }}");

      // Redirect Checkout Flow
      var checkoutButton = document.getElementById("checkout-button");
      if (checkoutButton) {
        checkoutButton.addEventListener("click", function(event) {
            event.preventDefault();
            
            fetch("{% url 'create_checkout_session' course_pk=course.id %}", {
                method: 'POST',
                headers: {
                    'X-CSRFToken': '{{ csrf_token }}',
                    'Content-Type': 'application/json'
                }
            })
            .then(response => {
                if (!response.ok) {
                    return response.json().then(errorData => {
                        throw new Error(errorData.error || 'Unknown error occurred');
                    });
                }
                return response.json();
            })
            .then(data => {
                if (data.checkout_url) {
                    window.location.href = data.checkout_url;
                } else {
                    console.error('No checkout URL found', data);
                    alert('Failed to create checkout session');
                }
            })
            .catch(error => {
                console.error('Error:', error);
                alert('An error occurred: ' + error.message);
            });
        });
      };
    </script>
  </body>
</html>